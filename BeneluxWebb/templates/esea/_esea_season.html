{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/match_box.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/table.css') }}">

<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/esea/esea_cards.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/esea/esea_card_details.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/esea/esea_card_details_table.css') }}">
{% endblock %}

{% block extra_js %}
{% endblock %}

{% for division_name, teams in divisions.items() %}
    {% if loop.first %}
        <div class="division-separator justify-content-between">
            <h3 class="text-left">{{ division_name }}</h3>
            <button id="expandAllBtn" class="btn btn-custom">Expand All</button>
        </div>
        <!-- Skip printing division title here, already printed above -->
    {% else %}
        <div class="division-separator">
            <h3 class="text-left">{{ division_name }}</h3>
        </div>
    {% endif %}

    {% for team in teams %}
    <div class="team-card">
        <div class="team-card-visible">
            <div class="team-card-body">
            
                <div class="team-avatar">
                    <img src="{{ team.team_avatar }}"
                        alt="Team Avatar"
                        data-placeholder="{{ url_for('static', filename='img/faceit/team_avatar_placeholder.jpg') }}"
                        onerror="this.onerror=null;this.src=this.dataset.placeholder;">
                </div>
                
                <div class="team-card-name">
                    <a class="team-link" href="https://www.faceit.com/en/teams/{{ team.team_id }}/leagues" target="_blank">
                        {{ team.team_name_cur }}
                    </a>
                </div>

                <div class="main-players-box">
                    {% for player in team.players_main %}
                    <a href="https://www.faceit.com/en/players/{{player.player_name}}" class="text-decoration-none text-reset" target="_blank">
                        <div class="main-player">
                            <div class="main-player-avatar">
                                <img src="{{ player.player_avatar }}"
                                    alt="{{ player.player_name }}"
                                    data-placeholder="{{ url_for('static', filename='img/faceit/player_avatar_placeholder.jpg') }}"
                                    onerror="this.onerror=null;this.src=this.dataset.placeholder;">
                            </div>
                            <div class="main-player-name">
                                <strong>{{ player.player_name }}</strong>
                                <img src="{{ url_for('static', filename='img/flags/' ~ player.player_country|lower ~ '.png') }}"
                                    alt="{{ player.player_country }}">
                            </div>
                        </div>
                    </a>
                    {% endfor%}
                </div>

                <div class="sub-players-box">
                    {% if team.players_sub %}
                    {% for player in team.players_sub %}
                    <a href="https://www.faceit.com/en/players/{{ player.player_name }}" class="text-decoration-none text-reset" target="_blank">
                        <div class="sub-player">
                            <img src="{{ url_for('static', filename='img/flags/' ~ player.player_country|lower ~ '.png') }}"
                                alt="{{ player.player_country }}">
                            <span>{{ player.player_name }}</span>
                        </div>
                    </a>
                    {% endfor %}
                    {% endif %}
                </div>

                <div class="score-boxes">
                    {% for stage in team.stages %}
                        <div class="stage-box" 
                            data-bs-toggle="tooltip" 
                            title="Placement: {{ stage.placement['left'] }}{% if stage.placement.get('right') is not none %} - {{ stage.placement['right'] }}{% endif %}">
                            
                            <div class="stage-logo">
                                <img 
                                    src="{{ url_for('static', filename='img/esea/' ~ ('regularSeason.png' if 'regular' in stage.stage_name|lower else 'playoffs.png')) }}"
                                    alt="ESEA Stage Logo">
                            </div>
                            <div class="stage-score">
                                <span style="color: #28a745;">
                                    {{ stage.wins or 0 }}
                                </span>
                                -
                                <span style="color: #dc3545;">
                                    {{ stage.losses or 0 }}
                                </span>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                
                <div class="details-btn">
                    <button class="btn collapsed" type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#collapseTeam{{ division_name | replace(' ', '') }}{{ loop.index }}"
                        aria-expanded="false"
                        aria-controls="collapseTeam{{ division_name | replace(' ', '') }}{{ loop.index }}">
                        <i class="bi bi-chevron-down"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Collapsible section for team details -->
        <div class="collapse" id="collapseTeam{{ division_name | replace(' ', '') }}{{ loop.index }}">
            <div class="collapse-body">

                <div class="details-box col">

                    <div class="details-box-header">
                        Recent Matches
                    </div>

                    <div class="matches-box recent">
                        {% if team.matches %}
                            {% for match in team.matches %}
                            <a href="https://www.faceit.com/en/cs2/room/{{ match.match_id }}" 
                                class="match-info-box {{ 'highlight-border' if match.opponent_id in teams | map(attribute='team_id') | list else '' }}" 
                                target="_blank" 
                                rel="noopener noreferrer">
                                
                                <div class="match-info-time">
                                    {% if match.match_time %}
                                        <span>{{ match.match_time | datetimeformat('%d/%m') }}<span>
                                    {% else %}
                                        <span>TBA</span>
                                    {% endif %}
                                </div>

                                <div class="match-info-team-wrapper">

                                    <img class="match-info-team-avatar"
                                        src="{{ team.team_avatar }}"
                                        alt="{{ team.team_name }}"
                                        loading="lazy"
                                        data-placeholder="{{ url_for('static', filename='img/faceit/team_avatar_placeholder.jpg') }}"
                                        onerror="this.onerror=null;this.src=this.dataset.placeholder;">

                                    <div class="match-score">
                                        {% if match.score == 'FFW' %}
                                            <span class="fst-italic text-success">{{ match.score }}</span>
                                        {% elif match.score == 'FFL' %}
                                            <span class="fst-italic text-danger">{{ match.score }}</span>
                                        {% else %}
                                            {% set parts = match.score.split('/') %}
                                            {% set score1 = parts[0] | trim | int %}
                                            {% set score2 = parts[1] | trim | int %}
                                            {% set is_win = match.result == 'W' %}
                                            {% set left = score1 if is_win and score1 > score2 or not is_win and score1 < score2 else score2 %}
                                            {% set right = score2 if left == score1 else score1 %}

                                            <span class="match-score-full">
                                                <span class="match-score-left {{ 'text-success' if is_win else 'text-danger' }}">
                                                    {{ left }}
                                                </span>
                                                <span class="match-score-divider">-</span>
                                                <span class="match-score-right {{ 'text-danger' if is_win else 'text-success' }}">
                                                    {{ right }}
                                                </span>
                                            </span>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="match-info-team opponent">
                                        <div class="match-info-avatar">
                                            <img src="{{ match.opponent_avatar }}"
                                                alt="{{ match.opponent }}"
                                                loading="lazy"
                                                data-placeholder="{{ url_for('static', filename='img/faceit/team_avatar_placeholder.jpg') }}"
                                                onerror="this.onerror=null;this.src=this.dataset.placeholder;">
                                        </div>
                                        <span class="match-info-name opponent">{{ match.opponent }}</span>
                                    </div>
                                </div>

                                <div class="match-info-maps">
                                    {% if match.maps_played %}
                                        {% for map in match.maps_played %}
                                            <img src="{{ url_for('static', filename='img/maps/' ~ map ~ '.png') }}"
                                                alt="{{ map }}"
                                                loading="lazy">
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            </a>
                            {% endfor %}
                        {% else %}
                            <p class="d-flex align-items-center text-muted mb-0">No recent matches.</p>
                        {% endif %}
                    </div>

                    <div class="details-box-header">
                        Upcoming Matches
                    </div>

                    <div class="matches-box upcoming">
                        {% if team.upcoming_matches %}
                            {% for match in team.upcoming_matches %}
                            <a href="https://www.faceit.com/en/cs2/room/{{ match.match_id }}" 
                                class="match-info-box {{ 'highlight-border' if match.opponent_id in teams | map(attribute='team_id') | list else '' }}" 
                                target="_blank" 
                                rel="noopener noreferrer">

                                <div class="match-info-time upcoming">
                                    {% if match.match_time %}
                                        <span>{{ match.match_time | datetimeformat('%d/%m %H:%M') }}<span>
                                    {% else %}
                                        <span>TBA</span>
                                    {% endif %}
                                </div>

                                <div class="match-info-team-wrapper">
                                    <img class="match-info-team-avatar"
                                        src="{{ team.team_avatar }}"
                                        alt="{{ team.team_name }}"
                                        loading="lazy"
                                        data-placeholder="{{ url_for('static', filename='img/faceit/team_avatar_placeholder.jpg') }}"
                                        onerror="this.onerror=null;this.src=this.dataset.placeholder;">

                                    <div class="match-score">
                                        <span> vs. </span>
                                    </div>

                                    <div class="match-info-team opponent">
                                        <div class="match-info-avatar">
                                            <img src="{{ match.opponent_avatar }}"
                                                alt="{{ match.opponent }}"
                                                loading="lazy"
                                                data-placeholder="{{ url_for('static', filename='img/faceit/team_avatar_placeholder.jpg') }}"
                                                onerror="this.onerror=null;this.src=this.dataset.placeholder;">
                                        </div>
                                        <span class="match-info-name opponent">{{ match.opponent }}</span>
                                    </div>
                                </div>
                            </a>
                            {% endfor %}
                        {% else %}
                            <p class="d-flex align-items-center text-muted mb-0">No upcoming matches.</p>
                        {% endif %}
                    </div>
                </div>
                
                <div class="details-box col">

                    <div class="details-box-header">
                        Map Statistics
                    </div>

                    {% if team.map_stats %}
                        <div class="maps-box">
                            {% for map in team.map_stats %}
                                <div class="map-stat-box"
                                    data-bs-toggle="tooltip"
                                    data-bs-placement="bottom"
                                    title="Played: {{ map.played }}, Won: {{ map.won }}">
                                    
                                    <img src="{{ url_for('static', filename='img/maps/' ~ map.map_name ~ '.png') }}"
                                        alt="{{ map.map_name }}"
                                        loading="lazy"
                                        data-placeholder="{{ url_for('static', filename='img/faceit/player_avatar_placeholder.jpg') }}"
                                    >
                                    <div class="map-name">
                                        {{ map.map_name | replace('de_', '')}}
                                    </div>
                                    <span class="map-badge badge
                                        {% if map.played == 0 %}{% elif map.winrate >= 50 %}bg-success{% else %}bg-danger{% endif %}">
                                        {% if map.played == 0 %}
                                            -
                                        {% else %}
                                            {{ map.winrate }} 
                                        {% endif %}
                                    </span>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="stats-box unavailable">
                            <p class="text-muted">No map stats available.</p>
                        </div>
                    {% endif %}

                    <!-- Player statistics -->
                    <div class="details-box-header">
                        Player Statistics
                        <a class="details-refer btn btn-custom"
                            href="/stats/player?events=esea&seasons={{ team.season_number }}&divisions={{ team.division_name }}&teams_name={{ team.team_name }}">
                            View All Stats
                        </a>
                    </div>

                    {% if team.player_stats %}
                        <div class="player-stats-box">
                            <input type="hidden"
                                id="player_stats_data_{{team['team_id']}}"
                                data-stats='{{ team.player_stats | tojson | safe }}'>
                            <table id="player_stats_table_{{team['team_id']}}" class="table custom-data-table align-middle table-sm">
                                <!-- DataTable will be initialized here -->
                            </table>
                        </div>
                    {% else %}
                        <div class="stats-box unavailable">
                            <p class="text-muted">No player stats available.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
{% endfor %}