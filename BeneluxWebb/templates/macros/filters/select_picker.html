{% macro select_picker(name, values, multiselect=False, init_selected=None) %}
{% set init_selected = init_selected if init_selected is not none else ([] if multiselect else []) %}
<div class="filter-container select-picker-container sidebar-button" data-filter-name="{{ name }}" data-default='{{ init_selected | tojson }}'>
    <select class="selectpicker" 
            id="{{ name }}-select"
            {% if multiselect %}multiple data-size="5"{% endif %}>
        {% for val in values %}
            <option value="{{ val }}"
                {% if multiselect and val in init_selected %}selected{% elif not multiselect and init_selected and val == init_selected[0] %}selected{% endif %}>
                {{ val }}
            </option>
        {% endfor %}
    </select>
</div>

<script>
(function() {
    const container = document.currentScript.previousElementSibling;
    const select = container.querySelector('select');

    // Initialize Bootstrap Select
    function updateValue() {
        const selected = Array.from(select.selectedOptions).map(opt => opt.value);
        container.dataset.value = JSON.stringify(selected);
    }

    // Initialize value
    updateValue();

    // Listen for external apply
    container.addEventListener('applyValuesFromUrl', (e) => {
        const values = e.detail || [];
        Array.from(select.options).forEach(option => {
            option.selected = values.includes(option.value);
        });
        // Refresh the selectpicker to reflect the new selection
        $(select).selectpicker('refresh');
        updateValue();
    }); 

    // Listen for changes
    select.addEventListener('change', updateValue);
})();
</script>
{% endmacro %}
